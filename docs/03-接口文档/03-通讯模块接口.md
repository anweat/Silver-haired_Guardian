# 银龄守候·双模交互版 - 通讯模块接口文档

> 文档版本：v1.0  
> 更新日期：2025年12月21日  
> 文档状态：待完善

---

## 目录

- [1. 接口概述](#1-接口概述)
- [2. WebSocket连接规范](#2-websocket连接规范)
- [3. 语音留言接口](#3-语音留言接口)
- [4. 消息推送接口](#4-消息推送接口)
- [5. 实时通话接口](#5-实时通话接口)
- [6. 紧急联系接口](#6-紧急联系接口)
- [7. 错误码定义](#7-错误码定义)

---

## 1. 接口概述

### 1.1 基础信息

- **服务名称**：通讯模块服务 (message-service)
- **基础路径**：`/api/v1/message`
- **WebSocket路径**：`wss://api.yinlingshouhou.com/ws`
- **认证方式**：JWT Bearer Token
- **数据格式**：JSON
- **字符编码**：UTF-8

### 1.2 功能模块

| 模块 | 说明 | 通信方式 |
|:----|:----|:---------|
| 语音留言 | 异步语音消息 | HTTP + OSS |
| 实时消息 | 即时文本/图片消息 | WebSocket |
| 实时通话 | 音视频通话 | WebRTC + 信令服务器 |
| 消息推送 | 系统通知推送 | APNs/FCM/JPush |
| 紧急联系 | 一键呼叫 | HTTP + 电话API |

### 1.3 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                     通讯模块架构                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  老年端APP              子女端APP                            │
│      │                     │                                │
│      ├──HTTP──┐       ┌───┤                                │
│      │        ▼       ▼    │                                │
│      │    ┌─────────────┐  │                                │
│      │    │  API网关    │  │                                │
│      │    └──────┬──────┘  │                                │
│      │           │          │                                │
│      │           ▼          │                                │
│      │    ┌─────────────┐  │                                │
│      │    │ 消息服务    │  │                                │
│      │    │ - 语音留言  │  │                                │
│      │    │ - 推送管理  │  │                                │
│      │    └──────┬──────┘  │                                │
│      │           │          │                                │
│      ├──WebSocket┼─────────┤                                │
│      │           │          │                                │
│      │           ▼          │                                │
│      │    ┌─────────────┐  │                                │
│      │    │WebSocket服务│  │                                │
│      │    │ - 实时消息  │  │                                │
│      │    │ - 在线状态  │  │                                │
│      │    └──────┬──────┘  │                                │
│      │           │          │                                │
│      └──WebRTC───┼─────────┘                                │
│                  │                                           │
│                  ▼                                           │
│           ┌─────────────┐                                    │
│           │  RabbitMQ   │  消息队列                          │
│           └─────────────┘                                    │
│                  │                                           │
│                  ├──► OSS (语音文件存储)                     │
│                  ├──► Redis (在线状态、消息缓存)             │
│                  └──► MySQL (消息持久化)                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 1.4 依赖服务

| 服务 | 用途 | 说明 |
|:----|:----|:-----|
| OSS | 语音文件存储 | 阿里云OSS，支持断点续传 |
| RabbitMQ | 消息队列 | 异步处理、削峰填谷 |
| Redis | 缓存 | 在线状态、未读消息计数 |
| JPush | 消息推送 | 极光推送服务 |
| WebRTC | 音视频通话 | P2P实时通信 |

## 2. WebSocket连接规范

### 2.1 建立连接

**连接地址**：`wss://api.yinlingshouhou.com/ws?token={accessToken}`

**连接参数**：

| 参数 | 类型 | 必填 | 说明 |
|:----|:----|:----|:-----|
| token | String | ✔ | JWT访问令牌 |

**连接示例**：

```javascript
const ws = new WebSocket(
  'wss://api.yinlingshouhou.com/ws?token=eyJhbGciOiJIUzI1NiIs...'
);

ws.onopen = () => {
  console.log('WebSocket连接成功');
};

ws.onerror = (error) => {
  console.error('WebSocket错误:', error);
};

ws.onclose = (event) => {
  console.log('WebSocket关闭:', event.code, event.reason);
};
```

### 2.2 消息格式

#### 2.2.1 客户端发送消息格式

```json
{
  "type": "MESSAGE_TYPE",
  "messageId": "msg_client_timestamp_random",
  "timestamp": 1704067200000,
  "payload": {
    // 具体消息内容
  }
}
```

#### 2.2.2 服务端响应格式

```json
{
  "type": "MESSAGE_TYPE",
  "messageId": "msg_server_timestamp_random",
  "timestamp": 1704067200000,
  "code": 200,
  "message": "success",
  "payload": {
    // 具体响应内容
  }
}
```

### 2.3 消息类型

| 类型 | 值 | 方向 | 说明 |
|:----|:---|:-----|:-----|
| 心跳 | `PING` / `PONG` | 双向 | 保持连接 |
| 认证 | `AUTH` | C→S | 连接认证 |
| 文本消息 | `TEXT_MESSAGE` | 双向 | 文本消息 |
| 图片消息 | `IMAGE_MESSAGE` | 双向 | 图片消息 |
| 语音消息通知 | `VOICE_MESSAGE` | S→C | 新语音留言通知 |
| 消息已读 | `MESSAGE_READ` | C→S | 标记消息已读 |
| 在线状态 | `ONLINE_STATUS` | S→C | 用户在线状态变化 |
| 通话信令 | `CALL_SIGNAL` | 双向 | WebRTC信令 |
| 系统通知 | `SYSTEM_NOTIFY` | S→C | 系统通知 |
| 错误 | `ERROR` | S→C | 错误消息 |

### 2.4 心跳机制

**客户端发送PING**：

```json
{
  "type": "PING",
  "messageId": "ping_1704067200",
  "timestamp": 1704067200000
}
```

**服务端响应PONG**：

```json
{
  "type": "PONG",
  "messageId": "pong_1704067200",
  "timestamp": 1704067201000
}
```

**心跳规则**：
- 客户端每30秒发送一次PING
- 服务端收到PING后立即回复PONG
- 连续3次PING无响应则断开重连
- 服务端90秒无心跳则主动断开连接

### 2.5 文本消息

**客户端发送**：

```json
{
  "type": "TEXT_MESSAGE",
  "messageId": "msg_1704067200_001",
  "timestamp": 1704067200000,
  "payload": {
    "toUserId": 1001,
    "content": "爸，今天感觉怎么样？",
    "contentType": "TEXT"
  }
}
```

**服务端响应**：

```json
{
  "type": "TEXT_MESSAGE",
  "messageId": "msg_1704067200_001",
  "timestamp": 1704067201000,
  "code": 200,
  "message": "success",
  "payload": {
    "messageId": "msg_server_1704067201_001",
    "fromUserId": 2001,
    "toUserId": 1001,
    "content": "爸，今天感觉怎么样？",
    "sendTime": 1704067200000,
    "status": "SENT"
  }
}
```

**服务端推送给接收方**：

```json
{
  "type": "TEXT_MESSAGE",
  "messageId": "msg_server_1704067201_001",
  "timestamp": 1704067201000,
  "payload": {
    "messageId": "msg_server_1704067201_001",
    "fromUserId": 2001,
    "fromUserName": "张小明",
    "fromUserAvatar": "https://oss.example.com/avatars/2001.jpg",
    "toUserId": 1001,
    "content": "爸，今天感觉怎么样？",
    "contentType": "TEXT",
    "sendTime": 1704067200000,
    "isRead": false
  }
}
```

### 2.6 图片消息

**客户端发送**：

```json
{
  "type": "IMAGE_MESSAGE",
  "messageId": "msg_1704067200_002",
  "timestamp": 1704067200000,
  "payload": {
    "toUserId": 1001,
    "imageUrl": "https://oss.example.com/images/20250101_001.jpg",
    "thumbnailUrl": "https://oss.example.com/images/thumb_20250101_001.jpg",
    "width": 1080,
    "height": 1920,
    "size": 524288
  }
}
```

### 2.7 消息已读回执

**客户端发送**：

```json
{
  "type": "MESSAGE_READ",
  "messageId": "read_1704067200",
  "timestamp": 1704067200000,
  "payload": {
    "messageIds": [
      "msg_server_1704067201_001",
      "msg_server_1704067201_002"
    ]
  }
}
```

**服务端响应**：

```json
{
  "type": "MESSAGE_READ",
  "messageId": "read_1704067200",
  "timestamp": 1704067201000,
  "code": 200,
  "message": "success",
  "payload": {
    "readCount": 2
  }
}
```

### 2.8 在线状态通知

**服务端推送**：

```json
{
  "type": "ONLINE_STATUS",
  "messageId": "status_1704067200",
  "timestamp": 1704067200000,
  "payload": {
    "userId": 2001,
    "status": "ONLINE",
    "lastActiveTime": 1704067200000
  }
}
```

**状态类型**：
- `ONLINE`：在线
- `OFFLINE`：离线
- `BUSY`：忙碌

### 2.9 错误处理

**错误响应格式**：

```json
{
  "type": "ERROR",
  "messageId": "error_1704067200",
  "timestamp": 1704067200000,
  "code": 4001,
  "message": "invalid_token",
  "payload": {
    "error": "Token已过期，请重新登录"
  }
}
```

**常见错误码**：

| 错误码 | 说明 |
|:------|:-----|
| 4001 | Token无效或过期 |
| 4002 | 消息格式错误 |
| 4003 | 接收方不存在 |
| 4004 | 消息发送失败 |
| 4005 | 连接超时 |

### 2.10 连接管理

**断线重连策略**：

```javascript
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;
const reconnectDelay = 2000; // 初始延迟2秒

function connect() {
  const ws = new WebSocket(`wss://api.yinlingshouhou.com/ws?token=${token}`);
  
  ws.onclose = (event) => {
    if (reconnectAttempts < maxReconnectAttempts) {
      const delay = reconnectDelay * Math.pow(2, reconnectAttempts);
      setTimeout(() => {
        reconnectAttempts++;
        connect();
      }, delay);
    }
  };
  
  ws.onopen = () => {
    reconnectAttempts = 0; // 重置重连次数
  };
}
```

**优雅关闭**：

```javascript
// 发送关闭消息
ws.send(JSON.stringify({
  type: 'CLOSE',
  messageId: 'close_' + Date.now(),
  timestamp: Date.now()
}));

// 关闭连接
ws.close(1000, 'Client closed connection');
```

## 3. 语音留言接口

### 3.1 发送语音留言

**接口地址**：`POST /api/v1/message/voice/send`

**请求头**：
```
Authorization: Bearer {accessToken}
Content-Type: multipart/form-data
```

**请求参数**：

| 字段 | 类型 | 必填 | 说明 |
|:----|:----|:----|:-----|
| toUserId | Long | ✔ | 接收方用户ID |
| audioFile | File | ✔ | 语音文件（MP3/WAV/AMR，≤10MB） |
| duration | Integer | ✔ | 时长（秒） |
| text | String | ✘ | 语音转文字内容 |

**响应示例**：

```json
{
  "code": 201,
  "message": "success",
  "data": {
    "messageId": "voice_msg_1704067200_001",
    "fromUserId": 2001,
    "toUserId": 1001,
    "audioUrl": "https://oss.example.com/voice/20250101_001.mp3",
    "duration": 15,
    "text": "爸，今天记得吃药哦",
    "sendTime": 1704067200000,
    "status": "SENT",
    "expiresAt": 1711843200000
  },
  "timestamp": 1704067200000
}
```

### 3.2 获取语音留言列表

**接口地址**：`GET /api/v1/message/voice/list`

**请求参数**：

| 字段 | 类型 | 必填 | 说明 |
|:----|:----|:----|:-----|
| type | String | ✘ | 类型：RECEIVED/SENT |
| isRead | Boolean | ✘ | 是否已读 |
| page | Integer | ✘ | 页码，默认1 |
| pageSize | Integer | ✘ | 每页数量，默认20 |

**示例**：`GET /api/v1/message/voice/list?type=RECEIVED&isRead=false`

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 15,
    "unreadCount": 5,
    "messages": [
      {
        "messageId": "voice_msg_1704067200_001",
        "fromUserId": 2001,
        "fromUserName": "张小明",
        "fromUserAvatar": "https://oss.example.com/avatars/2001.jpg",
        "toUserId": 1001,
        "audioUrl": "https://oss.example.com/voice/20250101_001.mp3",
        "duration": 15,
        "text": "爸，今天记得吃药哦",
        "sendTime": 1704067200000,
        "isRead": false,
        "readTime": null
      },
      {
        "messageId": "voice_msg_1703980800_001",
        "fromUserId": 2002,
        "fromUserName": "张小芳",
        "fromUserAvatar": "https://oss.example.com/avatars/2002.jpg",
        "toUserId": 1001,
        "audioUrl": "https://oss.example.com/voice/20241231_001.mp3",
        "duration": 20,
        "text": "爸，新年快乐！",
        "sendTime": 1703980800000,
        "isRead": true,
        "readTime": 1703984400000
      }
    ]
  },
  "timestamp": 1704067200000
}
```

### 3.3 播放语音留言

**接口地址**：`GET /api/v1/message/voice/{messageId}/play`

**路径参数**：
- `messageId`：消息ID

**功能说明**：
- 返回带签名的音频URL（有效期1小时）
- 自动标记为已读
- 记录播放时间

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "messageId": "voice_msg_1704067200_001",
    "audioUrl": "https://oss.example.com/voice/20250101_001.mp3?signature=xxx&expires=1704070800",
    "duration": 15,
    "text": "爸，今天记得吃药哦",
    "isRead": true,
    "readTime": 1704067800000
  },
  "timestamp": 1704067800000
}
```

### 3.4 删除语音留言

**接口地址**：`DELETE /api/v1/message/voice/{messageId}`

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "deleted": true
  },
  "timestamp": 1704067200000
}
```

### 3.5 批量标记已读

**接口地址**：`POST /api/v1/message/voice/mark-read`

**请求参数**：

```json
{
  "messageIds": [
    "voice_msg_1704067200_001",
    "voice_msg_1704067200_002"
  ]
}
```

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "successCount": 2,
    "failedCount": 0
  },
  "timestamp": 1704067200000
}
```

### 3.6 获取未读消息数

**接口地址**：`GET /api/v1/message/voice/unread-count`

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "totalUnread": 5,
    "byUser": [
      {
        "userId": 2001,
        "userName": "张小明",
        "unreadCount": 3
      },
      {
        "userId": 2002,
        "userName": "张小芳",
        "unreadCount": 2
      }
    ]
  },
  "timestamp": 1704067200000
}
```

### 3.7 语音转文字

**接口地址**：`POST /api/v1/message/voice/transcribe`

**请求参数**：

| 字段 | 类型 | 必填 | 说明 |
|:----|:----|:----|:-----|
| audioFile | File | ✔ | 语音文件 |
| language | String | ✘ | 语言：zh-CN/en-US，默认zh-CN |

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "text": "爸，今天记得吃药哦",
    "confidence": 0.95,
    "duration": 15,
    "language": "zh-CN"
  },
  "timestamp": 1704067200000
}
```

### 3.8 语音留言统计

**接口地址**：`GET /api/v1/message/voice/statistics`

**请求参数**：

| 字段 | 类型 | 必填 | 说明 |
|:----|:----|:----|:-----|
| startDate | String | ✔ | 开始日期 YYYY-MM-DD |
| endDate | String | ✔ | 结束日期 YYYY-MM-DD |

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "period": {
      "startDate": "2025-01-01",
      "endDate": "2025-01-31"
    },
    "totalSent": 45,
    "totalReceived": 38,
    "averageDuration": 18,
    "totalDuration": 1620,
    "readRate": 0.92,
    "dailyStats": [
      {
        "date": "2025-01-01",
        "sent": 2,
        "received": 1,
        "avgDuration": 15
      }
    ],
    "topSenders": [
      {
        "userId": 2001,
        "userName": "张小明",
        "messageCount": 20,
        "totalDuration": 380
      }
    ]
  },
  "timestamp": 1704067200000
}
```

## 4. 消息推送接口

### 4.1 注册推送Token

**接口地址**：`POST /api/v1/message/push/register`

**请求参数**：

```json
{
  "deviceId": "device_unique_id",
  "pushToken": "jpush_registration_id",
  "platform": "ANDROID",
  "appVersion": "1.0.0",
  "osVersion": "Android 13"
}
```

**平台类型**：
- `ANDROID`：安卓
- `IOS`：苹果
- `WEB`：网页

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "deviceId": "device_unique_id",
    "registered": true,
    "registeredTime": 1704067200000
  },
  "timestamp": 1704067200000
}
```

### 4.2 注销推送Token

**接口地址**：`DELETE /api/v1/message/push/unregister`

**请求参数**：

```json
{
  "deviceId": "device_unique_id"
}
```

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "unregistered": true
  },
  "timestamp": 1704067200000
}
```

### 4.3 推送通知类型

#### 4.3.1 新语音留言通知

**推送内容**：

```json
{
  "notificationType": "NEW_VOICE_MESSAGE",
  "title": "张小明给您留言了",
  "content": "爸，今天记得吃药哦",
  "badge": 5,
  "sound": "default",
  "extras": {
    "messageId": "voice_msg_1704067200_001",
    "fromUserId": 2001,
    "audioUrl": "https://oss.example.com/voice/20250101_001.mp3",
    "duration": 15
  }
}
```

#### 4.3.2 用药提醒通知

**推送内容**：

```json
{
  "notificationType": "MEDICINE_REMINDER",
  "title": "吃药提醒",
  "content": "该服用阿司匹林肠溶片了",
  "badge": 1,
  "sound": "reminder.mp3",
  "extras": {
    "reminderId": "rem_1001",
    "medicineName": "阿司匹林肠溶片",
    "dosage": "1片",
    "time": "08:00"
  }
}
```

#### 4.3.3 健康异常通知

**推送内容**：

```json
{
  "notificationType": "HEALTH_ALERT",
  "title": "健康提醒",
  "content": "您父亲的血压偏高（145/92），请关注",
  "badge": 1,
  "sound": "alert.mp3",
  "priority": "HIGH",
  "extras": {
    "userId": 1001,
    "dataType": "BLOOD_PRESSURE",
    "values": {
      "systolic": 145,
      "diastolic": 92
    },
    "status": "WARNING"
  }
}
```

#### 4.3.4 紧急求助通知

**推送内容**：

```json
{
  "notificationType": "EMERGENCY_CALL",
  "title": "紧急求助",
  "content": "张大爷触发了紧急求助！",
  "badge": 1,
  "sound": "emergency.mp3",
  "priority": "URGENT",
  "vibrate": true,
  "extras": {
    "userId": 1001,
    "userName": "张大爷",
    "timestamp": 1704067200000,
    "location": {
      "latitude": 39.9042,
      "longitude": 116.4074,
      "address": "北京市朝阳区xxx"
    }
  }
}
```

#### 4.3.5 系统通知

**推送内容**：

```json
{
  "notificationType": "SYSTEM_NOTIFY",
  "title": "系统通知",
  "content": "您的健康周报已生成",
  "badge": 1,
  "sound": "default",
  "extras": {
    "reportId": "report_20250101_001",
    "reportType": "WEEKLY",
    "overallScore": 85
  }
}
```

### 4.4 发送推送（服务端接口）

**接口地址**：`POST /api/v1/message/push/send`

**请求头**：
```
Authorization: Bearer {serviceToken}
Content-Type: application/json
```

**请求参数**：

```json
{
  "userIds": [1001, 1002],
  "notificationType": "MEDICINE_REMINDER",
  "title": "吃药提醒",
  "content": "该服用阿司匹林肠溶片了",
  "badge": 1,
  "sound": "reminder.mp3",
  "priority": "HIGH",
  "extras": {
    "reminderId": "rem_1001"
  },
  "schedule": {
    "sendTime": 1704067200000
  }
}
```

**优先级**：
- `LOW`：低优先级
- `NORMAL`：普通优先级
- `HIGH`：高优先级
- `URGENT`：紧急优先级（会强制震动和声音）

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "pushId": "push_1704067200_001",
    "targetCount": 2,
    "successCount": 2,
    "failedCount": 0,
    "sendTime": 1704067200000
  },
  "timestamp": 1704067200000
}
```

### 4.5 推送设置

**接口地址**：`PUT /api/v1/message/push/settings`

**请求参数**：

```json
{
  "enablePush": true,
  "enableSound": true,
  "enableVibrate": true,
  "quietHours": {
    "enabled": true,
    "startTime": "22:00",
    "endTime": "07:00"
  },
  "notificationTypes": {
    "NEW_VOICE_MESSAGE": true,
    "MEDICINE_REMINDER": true,
    "HEALTH_ALERT": true,
    "EMERGENCY_CALL": true,
    "SYSTEM_NOTIFY": false
  }
}
```

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "updated": true
  },
  "timestamp": 1704067200000
}
```

### 4.6 获取推送设置

**接口地址**：`GET /api/v1/message/push/settings`

**响应格式**：同4.5设置接口

### 4.7 推送历史记录

**接口地址**：`GET /api/v1/message/push/history`

**请求参数**：

| 字段 | 类型 | 必填 | 说明 |
|:----|:----|:----|:-----|
| notificationType | String | ✘ | 通知类型 |
| startDate | String | ✘ | 开始日期 |
| endDate | String | ✘ | 结束日期 |
| page | Integer | ✘ | 页码 |
| pageSize | Integer | ✘ | 每页数量 |

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 50,
    "notifications": [
      {
        "pushId": "push_1704067200_001",
        "notificationType": "MEDICINE_REMINDER",
        "title": "吃药提醒",
        "content": "该服用阿司匹林肠溶片了",
        "sendTime": 1704067200000,
        "isRead": true,
        "readTime": 1704067500000
      }
    ]
  },
  "timestamp": 1704067200000
}
```

### 4.8 清除推送通知

**接口地址**：`DELETE /api/v1/message/push/clear`

**请求参数**：

```json
{
  "pushIds": ["push_1704067200_001"],
  "clearAll": false
}
```

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "clearedCount": 1
  },
  "timestamp": 1704067200000
}
```

## 5. 实时通话接口

### 5.1 通话信令流程

```
发起方                    信令服务器                    接收方
  │                          │                          │
  │─(1) 发起通话请求────────►│                          │
  │                          │                          │
  │◄────返回callId───────────│                          │
  │                          │                          │
  │                          │─(2) 推送通话邀请─────────►│
  │                          │                          │
  │                          │◄─(3) 接受/拒绝───────────│
  │                          │                          │
  │◄────通知接受/拒绝────────│                          │
  │                          │                          │
  │─(4) 交换ICE Candidates──►│─转发ICE───────────────►│
  │                          │                          │
  │◄─────────────────────────│◄─────────────────────────│
  │                          │                          │
  │═══════════P2P连接建立═══════════════════════════════│
  │                          │                          │
  │─(5) 通话结束通知─────────►│                          │
  │                          │                          │
  │                          │─转发结束通知─────────────►│
```

### 5.2 发起通话

**接口地址**：`POST /api/v1/message/call/initiate`

**请求参数**：

```json
{
  "toUserId": 1001,
  "callType": "VOICE",
  "sdp": {
    "type": "offer",
    "sdp": "v=0\no=- 123456789 2 IN IP4 192.168.1.1..."
  }
}
```

**通话类型**：
- `VOICE`：语音通话
- `VIDEO`：视频通话

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "callId": "call_1704067200_001",
    "fromUserId": 2001,
    "toUserId": 1001,
    "callType": "VOICE",
    "status": "RINGING",
    "initiateTime": 1704067200000
  },
  "timestamp": 1704067200000
}
```

### 5.3 接受通话

**接口地址**：`POST /api/v1/message/call/{callId}/accept`

**请求参数**：

```json
{
  "sdp": {
    "type": "answer",
    "sdp": "v=0\no=- 987654321 2 IN IP4 192.168.1.2..."
  }
}
```

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "callId": "call_1704067200_001",
    "status": "CONNECTED",
    "acceptTime": 1704067205000
  },
  "timestamp": 1704067205000
}
```

### 5.4 拒绝通话

**接口地址**：`POST /api/v1/message/call/{callId}/reject`

**请求参数**：

```json
{
  "reason": "BUSY"
}
```

**拒绝原因**：
- `BUSY`：忙碌
- `DECLINED`：主动拒绝
- `UNAVAILABLE`：不可用

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "callId": "call_1704067200_001",
    "status": "REJECTED",
    "rejectTime": 1704067205000,
    "reason": "BUSY"
  },
  "timestamp": 1704067205000
}
```

### 5.5 交换ICE Candidate

**接口地址**：`POST /api/v1/message/call/{callId}/ice-candidate`

**请求参数**：

```json
{
  "candidate": {
    "candidate": "candidate:1 1 UDP 2130706431 192.168.1.1 54321 typ host",
    "sdpMid": "0",
    "sdpMLineIndex": 0
  }
}
```

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "callId": "call_1704067200_001",
    "candidateAdded": true
  },
  "timestamp": 1704067200000
}
```

### 5.6 结束通话

**接口地址**：`POST /api/v1/message/call/{callId}/hangup`

**请求参数**：

```json
{
  "reason": "NORMAL"
}
```

**结束原因**：
- `NORMAL`：正常挂断
- `TIMEOUT`：超时未接听
- `ERROR`：连接错误
- `NETWORK_ERROR`：网络错误

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "callId": "call_1704067200_001",
    "status": "ENDED",
    "duration": 125,
    "endTime": 1704067325000,
    "reason": "NORMAL"
  },
  "timestamp": 1704067325000
}
```

### 5.7 通话记录

**接口地址**：`GET /api/v1/message/call/history`

**请求参数**：

| 字段 | 类型 | 必填 | 说明 |
|:----|:----|:----|:-----|
| callType | String | ✘ | 通话类型 |
| status | String | ✘ | 通话状态 |
| startDate | String | ✘ | 开始日期 |
| endDate | String | ✘ | 结束日期 |
| page | Integer | ✘ | 页码 |
| pageSize | Integer | ✘ | 每页数量 |

**通话状态**：
- `RINGING`：响铃中
- `CONNECTED`：已连接
- `ENDED`：已结束
- `REJECTED`：已拒绝
- `MISSED`：未接听
- `CANCELLED`：已取消

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 30,
    "calls": [
      {
        "callId": "call_1704067200_001",
        "fromUserId": 2001,
        "fromUserName": "张小明",
        "fromUserAvatar": "https://oss.example.com/avatars/2001.jpg",
        "toUserId": 1001,
        "toUserName": "张大爷",
        "callType": "VOICE",
        "status": "ENDED",
        "duration": 125,
        "initiateTime": 1704067200000,
        "acceptTime": 1704067205000,
        "endTime": 1704067325000,
        "reason": "NORMAL"
      },
      {
        "callId": "call_1703980800_001",
        "fromUserId": 1001,
        "fromUserName": "张大爷",
        "toUserId": 2001,
        "toUserName": "张小明",
        "callType": "VIDEO",
        "status": "MISSED",
        "duration": 0,
        "initiateTime": 1703980800000,
        "endTime": 1703980860000,
        "reason": "TIMEOUT"
      }
    ]
  },
  "timestamp": 1704067200000
}
```

### 5.8 获取通话详情

**接口地址**：`GET /api/v1/message/call/{callId}`

**响应格式**：同5.7通话记录中的单条记录

### 5.9 删除通话记录

**接口地址**：`DELETE /api/v1/message/call/{callId}`

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "deleted": true
  },
  "timestamp": 1704067200000
}
```

### 5.10 通话统计

**接口地址**：`GET /api/v1/message/call/statistics`

**请求参数**：

| 字段 | 类型 | 必填 | 说明 |
|:----|:----|:----|:-----|
| startDate | String | ✔ | 开始日期 |
| endDate | String | ✔ | 结束日期 |

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "period": {
      "startDate": "2025-01-01",
      "endDate": "2025-01-31"
    },
    "totalCalls": 45,
    "voiceCalls": 30,
    "videoCalls": 15,
    "answeredCalls": 38,
    "missedCalls": 5,
    "rejectedCalls": 2,
    "totalDuration": 5400,
    "averageDuration": 142,
    "answerRate": 0.844,
    "dailyStats": [
      {
        "date": "2025-01-01",
        "totalCalls": 2,
        "answeredCalls": 2,
        "totalDuration": 280
      }
    ],
    "topCallers": [
      {
        "userId": 2001,
        "userName": "张小明",
        "callCount": 20,
        "totalDuration": 2500
      }
    ]
  },
  "timestamp": 1704067200000
}
```

### 5.11 WebSocket信令消息

#### 5.11.1 通话邀请（服务端推送）

```json
{
  "type": "CALL_SIGNAL",
  "messageId": "signal_1704067200_001",
  "timestamp": 1704067200000,
  "payload": {
    "signalType": "INVITE",
    "callId": "call_1704067200_001",
    "fromUserId": 2001,
    "fromUserName": "张小明",
    "fromUserAvatar": "https://oss.example.com/avatars/2001.jpg",
    "callType": "VOICE",
    "sdp": {
      "type": "offer",
      "sdp": "v=0\no=- 123456789 2 IN IP4..."
    }
  }
}
```

#### 5.11.2 通话接受（双向）

```json
{
  "type": "CALL_SIGNAL",
  "messageId": "signal_1704067205_001",
  "timestamp": 1704067205000,
  "payload": {
    "signalType": "ACCEPT",
    "callId": "call_1704067200_001",
    "sdp": {
      "type": "answer",
      "sdp": "v=0\no=- 987654321 2 IN IP4..."
    }
  }
}
```

#### 5.11.3 ICE Candidate（双向）

```json
{
  "type": "CALL_SIGNAL",
  "messageId": "signal_1704067206_001",
  "timestamp": 1704067206000,
  "payload": {
    "signalType": "ICE_CANDIDATE",
    "callId": "call_1704067200_001",
    "candidate": {
      "candidate": "candidate:1 1 UDP 2130706431...",
      "sdpMid": "0",
      "sdpMLineIndex": 0
    }
  }
}
```

#### 5.11.4 通话挂断（双向）

```json
{
  "type": "CALL_SIGNAL",
  "messageId": "signal_1704067325_001",
  "timestamp": 1704067325000,
  "payload": {
    "signalType": "HANGUP",
    "callId": "call_1704067200_001",
    "reason": "NORMAL",
    "duration": 125
  }
}
```

## 6. 紧急联系接口

### 6.1 触发紧急求助

**接口地址**：`POST /api/v1/message/emergency/trigger`

**请求参数**：

```json
{
  "triggerType": "MANUAL",
  "location": {
    "latitude": 39.9042,
    "longitude": 116.4074,
    "address": "北京市朝阳区xxx",
    "accuracy": 10
  },
  "note": "感觉不舒服，需要帮助"
}
```

**触发类型**：
- `MANUAL`：手动触发（用户主动点击）
- `FALL_DETECTION`：跌倒检测
- `HEALTH_ALERT`：健康异常
- `SOS_BUTTON`：SOS按钮

**响应示例**：

```json
{
  "code": 201,
  "message": "success",
  "data": {
    "emergencyId": "emergency_1704067200_001",
    "userId": 1001,
    "userName": "张大爷",
    "triggerType": "MANUAL",
    "triggerTime": 1704067200000,
    "location": {
      "latitude": 39.9042,
      "longitude": 116.4074,
      "address": "北京市朝阳区xxx"
    },
    "status": "ACTIVE",
    "notifiedContacts": [
      {
        "userId": 2001,
        "name": "张小明",
        "relation": "SON",
        "notifyTime": 1704067200000,
        "notifyMethod": "PUSH"
      },
      {
        "userId": 2002,
        "name": "张小芳",
        "relation": "DAUGHTER",
        "notifyTime": 1704067200000,
        "notifyMethod": "PUSH"
      }
    ]
  },
  "timestamp": 1704067200000
}
```

### 6.2 响应紧急求助

**接口地址**：`POST /api/v1/message/emergency/{emergencyId}/respond`

**请求参数**：

```json
{
  "responseType": "ACKNOWLEDGED",
  "message": "我马上过去",
  "estimatedArrival": 1704070800000
}
```

**响应类型**：
- `ACKNOWLEDGED`：已知晓，正在处理
- `ON_THE_WAY`：在路上
- `ARRIVED`：已到达
- `RESOLVED`：已解决
- `CALL_EMERGENCY`：已拨打120/110

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "emergencyId": "emergency_1704067200_001",
    "responderId": 2001,
    "responderName": "张小明",
    "responseType": "ACKNOWLEDGED",
    "responseTime": 1704067300000,
    "message": "我马上过去"
  },
  "timestamp": 1704067300000
}
```

### 6.3 取消紧急求助

**接口地址**：`POST /api/v1/message/emergency/{emergencyId}/cancel`

**请求参数**：

```json
{
  "reason": "误触，已无大碍"
}
```

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "emergencyId": "emergency_1704067200_001",
    "status": "CANCELLED",
    "cancelTime": 1704067500000,
    "reason": "误触，已无大碍"
  },
  "timestamp": 1704067500000
}
```

### 6.4 获取紧急联系人

**接口地址**：`GET /api/v1/message/emergency/contacts`

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "primaryContacts": [
      {
        "userId": 2001,
        "name": "张小明",
        "relation": "SON",
        "phone": "139****9000",
        "avatar": "https://oss.example.com/avatars/2001.jpg",
        "priority": 1,
        "notifyMethods": ["PUSH", "SMS", "CALL"]
      },
      {
        "userId": 2002,
        "name": "张小芳",
        "relation": "DAUGHTER",
        "phone": "135****5000",
        "avatar": "https://oss.example.com/avatars/2002.jpg",
        "priority": 2,
        "notifyMethods": ["PUSH", "SMS"]
      }
    ],
    "emergencyNumbers": [
      {
        "name": "急救中心",
        "number": "120",
        "type": "MEDICAL"
      },
      {
        "name": "报警电话",
        "number": "110",
        "type": "POLICE"
      },
      {
        "name": "社区医院",
        "number": "010-12345678",
        "type": "COMMUNITY"
      }
    ]
  },
  "timestamp": 1704067200000
}
```

### 6.5 设置紧急联系人

**接口地址**：`PUT /api/v1/message/emergency/contacts`

**请求参数**：

```json
{
  "primaryContacts": [
    {
      "userId": 2001,
      "priority": 1,
      "notifyMethods": ["PUSH", "SMS", "CALL"]
    },
    {
      "userId": 2002,
      "priority": 2,
      "notifyMethods": ["PUSH", "SMS"]
    }
  ],
  "emergencyNumbers": [
    {
      "name": "社区医院",
      "number": "010-12345678",
      "type": "COMMUNITY"
    }
  ]
}
```

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "updated": true
  },
  "timestamp": 1704067200000
}
```

### 6.6 紧急求助历史

**接口地址**：`GET /api/v1/message/emergency/history`

**请求参数**：

| 字段 | 类型 | 必填 | 说明 |
|:----|:----|:----|:-----|
| status | String | ✘ | 状态：ACTIVE/RESOLVED/CANCELLED |
| startDate | String | ✘ | 开始日期 |
| endDate | String | ✘ | 结束日期 |
| page | Integer | ✘ | 页码 |
| pageSize | Integer | ✘ | 每页数量 |

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 5,
    "emergencies": [
      {
        "emergencyId": "emergency_1704067200_001",
        "userId": 1001,
        "userName": "张大爷",
        "triggerType": "MANUAL",
        "triggerTime": 1704067200000,
        "status": "RESOLVED",
        "location": {
          "latitude": 39.9042,
          "longitude": 116.4074,
          "address": "北京市朝阳区xxx"
        },
        "responseCount": 2,
        "responseTime": 180,
        "resolveTime": 1704070800000,
        "note": "感觉不舒服，需要帮助"
      }
    ]
  },
  "timestamp": 1704067200000
}
```

### 6.7 获取紧急求助详情

**接口地址**：`GET /api/v1/message/emergency/{emergencyId}`

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "emergencyId": "emergency_1704067200_001",
    "userId": 1001,
    "userName": "张大爷",
    "userPhone": "138****8000",
    "userAvatar": "https://oss.example.com/avatars/1001.jpg",
    "triggerType": "MANUAL",
    "triggerTime": 1704067200000,
    "status": "RESOLVED",
    "location": {
      "latitude": 39.9042,
      "longitude": 116.4074,
      "address": "北京市朝阳区xxx",
      "accuracy": 10
    },
    "note": "感觉不舒服，需要帮助",
    "responses": [
      {
        "responderId": 2001,
        "responderName": "张小明",
        "responseType": "ACKNOWLEDGED",
        "responseTime": 1704067300000,
        "message": "我马上过去"
      },
      {
        "responderId": 2002,
        "responderName": "张小芳",
        "responseType": "ACKNOWLEDGED",
        "responseTime": 1704067320000,
        "message": "已通知哥哥"
      },
      {
        "responderId": 2001,
        "responderName": "张小明",
        "responseType": "ARRIVED",
        "responseTime": 1704070200000,
        "message": "已到达，没有大碍"
      },
      {
        "responderId": 2001,
        "responderName": "张小明",
        "responseType": "RESOLVED",
        "responseTime": 1704070800000,
        "message": "已解决，老人只是有点头晕，已休息"
      }
    ],
    "timeline": [
      {
        "time": 1704067200000,
        "event": "TRIGGERED",
        "description": "张大爷触发紧急求助"
      },
      {
        "time": 1704067200000,
        "event": "NOTIFIED",
        "description": "已通知2位紧急联系人"
      },
      {
        "time": 1704067300000,
        "event": "RESPONDED",
        "description": "张小明：我马上过去"
      },
      {
        "time": 1704070200000,
        "event": "ARRIVED",
        "description": "张小明已到达"
      },
      {
        "time": 1704070800000,
        "event": "RESOLVED",
        "description": "紧急情况已解决"
      }
    ]
  },
  "timestamp": 1704067200000
}
```

### 6.8 一键拨打紧急电话

**接口地址**：`POST /api/v1/message/emergency/call`

**请求参数**：

```json
{
  "phoneNumber": "120",
  "callType": "MEDICAL",
  "location": {
    "latitude": 39.9042,
    "longitude": 116.4074,
    "address": "北京市朝阳区xxx"
  }
}
```

**呼叫类型**：
- `MEDICAL`：医疗急救（120）
- `POLICE`：报警（110）
- `FIRE`：火警（119）
- `COMMUNITY`：社区电话
- `CONTACT`：紧急联系人

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "callId": "call_emergency_1704067200_001",
    "phoneNumber": "120",
    "callType": "MEDICAL",
    "initiateTime": 1704067200000,
    "notifiedFamily": true
  },
  "timestamp": 1704067200000
}
```

### 6.9 紧急求助统计

**接口地址**：`GET /api/v1/message/emergency/statistics`

**请求参数**：

| 字段 | 类型 | 必填 | 说明 |
|:----|:----|:----|:-----|
| startDate | String | ✔ | 开始日期 |
| endDate | String | ✔ | 结束日期 |

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "period": {
      "startDate": "2025-01-01",
      "endDate": "2025-12-31"
    },
    "totalEmergencies": 8,
    "byTriggerType": {
      "MANUAL": 5,
      "FALL_DETECTION": 2,
      "HEALTH_ALERT": 1
    },
    "byStatus": {
      "RESOLVED": 6,
      "CANCELLED": 2,
      "ACTIVE": 0
    },
    "averageResponseTime": 165,
    "fastestResponse": 45,
    "slowestResponse": 420,
    "monthlyStats": [
      {
        "month": "2025-01",
        "count": 2,
        "avgResponseTime": 180
      }
    ]
  },
  "timestamp": 1704067200000
}
```

### 6.10 紧急求助通知（WebSocket推送）

**服务端推送给家人**：

```json
{
  "type": "SYSTEM_NOTIFY",
  "messageId": "notify_1704067200_001",
  "timestamp": 1704067200000,
  "payload": {
    "notifyType": "EMERGENCY_ALERT",
    "emergencyId": "emergency_1704067200_001",
    "userId": 1001,
    "userName": "张大爷",
    "userAvatar": "https://oss.example.com/avatars/1001.jpg",
    "triggerType": "MANUAL",
    "triggerTime": 1704067200000,
    "location": {
      "latitude": 39.9042,
      "longitude": 116.4074,
      "address": "北京市朝阳区xxx"
    },
    "note": "感觉不舒服，需要帮助",
    "priority": "URGENT"
  }
}
```

**响应更新推送**：

```json
{
  "type": "SYSTEM_NOTIFY",
  "messageId": "notify_1704067300_001",
  "timestamp": 1704067300000,
  "payload": {
    "notifyType": "EMERGENCY_UPDATE",
    "emergencyId": "emergency_1704067200_001",
    "updateType": "RESPONSE_ADDED",
    "responderId": 2001,
    "responderName": "张小明",
    "responseType": "ACKNOWLEDGED",
    "message": "我马上过去"
  }
}
```

## 7. 错误码定义

### 7.1 通用错误码

| 错误码 | 错误消息 | 说明 |
|:------|:--------|:-----|
| 200 | success | 成功 |
| 400 | bad_request | 请求参数错误 |
| 401 | unauthorized | 未授权 |
| 403 | forbidden | 禁止访问 |
| 404 | not_found | 资源不存在 |
| 500 | internal_error | 服务器错误 |
| 503 | service_unavailable | 服务不可用 |

### 7.2 WebSocket连接错误

| 错误码 | 错误消息 | 说明 |
|:------|:--------|:-----|
| 4001 | invalid_token | Token无效或过期 |
| 4002 | connection_limit_exceeded | 连接数超限 |
| 4003 | duplicate_connection | 重复连接 |
| 4004 | message_format_error | 消息格式错误 |
| 4005 | heartbeat_timeout | 心跳超时 |
| 4006 | protocol_error | 协议错误 |

### 7.3 消息发送错误

| 错误码 | 错误消息 | 说明 |
|:------|:--------|:-----|
| 4101 | recipient_not_found | 接收方不存在 |
| 4102 | recipient_offline | 接收方离线 |
| 4103 | message_too_large | 消息体过大 |
| 4104 | send_failed | 消息发送失败 |
| 4105 | blocked_by_recipient | 被接收方屏蔽 |
| 4106 | rate_limit_exceeded | 发送频率超限 |

### 7.4 语音留言错误

| 错误码 | 错误消息 | 说明 |
|:------|:--------|:-----|
| 4201 | invalid_audio_format | 音频格式不支持 |
| 4202 | audio_too_large | 音频文件过大 |
| 4203 | audio_too_short | 音频时长过短 |
| 4204 | audio_too_long | 音频时长过长 |
| 4205 | upload_failed | 上传失败 |
| 4206 | transcribe_failed | 转文字失败 |
| 4207 | voice_message_not_found | 语音留言不存在 |
| 4208 | voice_expired | 语音已过期 |

### 7.5 推送通知错误

| 错误码 | 错误消息 | 说明 |
|:------|:--------|:-----|
| 4301 | push_token_invalid | 推送Token无效 |
| 4302 | push_service_unavailable | 推送服务不可用 |
| 4303 | push_failed | 推送失败 |
| 4304 | device_not_registered | 设备未注册 |
| 4305 | notification_disabled | 用户已关闭通知 |

### 7.6 通话错误

| 错误码 | 错误消息 | 说明 |
|:------|:--------|:-----|
| 4401 | call_not_found | 通话不存在 |
| 4402 | recipient_busy | 对方忙碌 |
| 4403 | recipient_unavailable | 对方不可用 |
| 4404 | call_timeout | 通话超时 |
| 4405 | connection_failed | 连接失败 |
| 4406 | network_error | 网络错误 |
| 4407 | ice_negotiation_failed | ICE协商失败 |
| 4408 | media_error | 媒体错误 |
| 4409 | permission_denied | 权限被拒绝（麦克风/摄像头） |

### 7.7 紧急求助错误

| 错误码 | 错误消息 | 说明 |
|:------|:--------|:-----|
| 4501 | emergency_not_found | 紧急求助不存在 |
| 4502 | emergency_already_resolved | 紧急情况已解决 |
| 4503 | no_emergency_contacts | 未设置紧急联系人 |
| 4504 | notify_failed | 通知失败 |
| 4505 | location_unavailable | 位置信息不可用 |
| 4506 | call_emergency_failed | 拨打紧急电话失败 |

### 7.8 错误响应示例

#### 7.8.1 Token过期

```json
{
  "code": 401,
  "message": "invalid_token",
  "errors": [
    {
      "field": "token",
      "message": "Token已过期，请重新登录"
    }
  ],
  "timestamp": 1704067200000
}
```

#### 7.8.2 接收方不存在

```json
{
  "code": 404,
  "message": "recipient_not_found",
  "errors": [
    {
      "field": "toUserId",
      "message": "接收方用户ID 9999不存在"
    }
  ],
  "timestamp": 1704067200000
}
```

#### 7.8.3 音频文件过大

```json
{
  "code": 400,
  "message": "audio_too_large",
  "errors": [
    {
      "field": "audioFile",
      "message": "音频文件大小12MB超过限制（最大10MB）"
    }
  ],
  "timestamp": 1704067200000
}
```

#### 7.8.4 推送服务不可用

```json
{
  "code": 503,
  "message": "push_service_unavailable",
  "errors": [
    {
      "field": "service",
      "message": "推送服务暂时不可用，请稍后重试"
    }
  ],
  "timestamp": 1704067200000
}
```

#### 7.8.5 通话连接失败

```json
{
  "code": 500,
  "message": "connection_failed",
  "errors": [
    {
      "field": "call",
      "message": "WebRTC连接失败，请检查网络设置"
    }
  ],
  "timestamp": 1704067200000
}
```

---

## 附录：业务规则

### A.1 消息限制

| 限制项 | 限制值 | 说明 |
|:------|:------|:-----|
| 文本消息长度 | 5000字符 | 超过需分段发送 |
| 图片大小 | 10MB | 自动压缩到限制内 |
| 语音时长 | 3-120秒 | 最短3秒，最长2分钟 |
| 语音文件大小 | 10MB | MP3/WAV/AMR格式 |
| 每分钟发送量 | 60条 | 防止刷屏 |

### A.2 在线状态规则

| 状态 | 触发条件 | 说明 |
|:----|:---------|:-----|
| ONLINE | WebSocket连接成功 | 在线 |
| OFFLINE | WebSocket断开超过30秒 | 离线 |
| BUSY | 正在通话中 | 忙碌 |

**状态更新策略**：
- 连接成功后立即广播在线状态
- 断开连接30秒后更新为离线
- 5分钟无操作自动切换为"离开"状态

### A.3 语音留言规则

1. **有效期**
   - 默认保存90天
   - 已读消息保存30天
   - 过期自动删除

2. **存储位置**
   - OSS云存储
   - 使用CDN加速
   - 自动备份

3. **转文字**
   - 使用讯飞ASR
   - 准确率>90%
   - 支持方言识别

### A.4 通话质量控制

| 指标 | 目标值 | 说明 |
|:----|:------|:-----|
| 连接成功率 | >95% | P2P连接建立成功率 |
| 延迟 | <200ms | 端到端延迟 |
| 丢包率 | <3% | 网络丢包率 |
| 分辨率 | 720p | 视频分辨率 |
| 帧率 | 15-30fps | 视频帧率 |
| 码率 | 500kbps | 音频+视频总码率 |

**网络自适应**：
- 根据网络状况自动调整码率
- 弱网环境下自动降低分辨率
- 超过5秒无响应自动断开重连

### A.5 紧急求助规则

1. **通知机制**
   - 同时通知所有紧急联系人
   - 推送、短信、电话三重保障
   - 15秒内未响应自动升级

2. **优先级**
   ```
   URGENT（紧急） > HIGH（高） > NORMAL（普通）
   
   - URGENT：立即推送+震动+声音+电话
   - HIGH：立即推送+震动+声音
   - NORMAL：静默推送
   ```

3. **自动升级**
   - 触发后15秒无响应：短信通知
   - 30秒无响应：电话呼叫第一联系人
   - 60秒无响应：依次呼叫其他联系人

4. **误触保护**
   - 需长按3秒确认
   - 10秒内可取消
   - 记录误触次数

---

## 附录：数据模型

### B.1 语音留言模型

```typescript
interface VoiceMessage {
  messageId: string;
  fromUserId: number;
  toUserId: number;
  audioUrl: string;
  duration: number;
  text?: string;
  sendTime: number;
  isRead: boolean;
  readTime?: number;
  expiresAt: number;
}
```

### B.2 通话记录模型

```typescript
interface CallRecord {
  callId: string;
  fromUserId: number;
  toUserId: number;
  callType: 'VOICE' | 'VIDEO';
  status: 'RINGING' | 'CONNECTED' | 'ENDED' | 'REJECTED' | 'MISSED' | 'CANCELLED';
  duration: number;
  initiateTime: number;
  acceptTime?: number;
  endTime?: number;
  reason?: string;
}
```

### B.3 紧急求助模型

```typescript
interface EmergencyAlert {
  emergencyId: string;
  userId: number;
  triggerType: 'MANUAL' | 'FALL_DETECTION' | 'HEALTH_ALERT' | 'SOS_BUTTON';
  triggerTime: number;
  status: 'ACTIVE' | 'RESOLVED' | 'CANCELLED';
  location: {
    latitude: number;
    longitude: number;
    address: string;
    accuracy: number;
  };
  note?: string;
  responses: EmergencyResponse[];
  resolveTime?: number;
}

interface EmergencyResponse {
  responderId: number;
  responderName: string;
  responseType: 'ACKNOWLEDGED' | 'ON_THE_WAY' | 'ARRIVED' | 'RESOLVED' | 'CALL_EMERGENCY';
  responseTime: number;
  message?: string;
}
```

### B.4 推送通知模型

```typescript
interface PushNotification {
  pushId: string;
  userId: number;
  notificationType: string;
  title: string;
  content: string;
  badge: number;
  sound: string;
  priority: 'LOW' | 'NORMAL' | 'HIGH' | 'URGENT';
  extras: Record<string, any>;
  sendTime: number;
  isRead: boolean;
  readTime?: number;
}
```

---

## 附录：集成示例

### C.1 Android WebSocket集成

```kotlin
class MessageWebSocketClient(
    private val token: String,
    private val listener: MessageListener
) {
    private var webSocket: WebSocket? = null
    private val client = OkHttpClient.Builder()
        .readTimeout(30, TimeUnit.SECONDS)
        .build()
    
    fun connect() {
        val request = Request.Builder()
            .url("wss://api.yinlingshouhou.com/ws?token=$token")
            .build()
        
        webSocket = client.newWebSocket(request, object : WebSocketListener() {
            override fun onOpen(webSocket: WebSocket, response: Response) {
                listener.onConnected()
                startHeartbeat()
            }
            
            override fun onMessage(webSocket: WebSocket, text: String) {
                handleMessage(text)
            }
            
            override fun onFailure(webSocket: WebSocket, t: Throwable, response: Response?) {
                listener.onError(t)
                reconnect()
            }
            
            override fun onClosed(webSocket: WebSocket, code: Int, reason: String) {
                listener.onDisconnected()
            }
        })
    }
    
    fun sendMessage(message: Message) {
        val json = Json.encodeToString(message)
        webSocket?.send(json)
    }
    
    private fun startHeartbeat() {
        // 每30秒发送心跳
    }
    
    private fun handleMessage(text: String) {
        val message = Json.decodeFromString<Message>(text)
        when (message.type) {
            "TEXT_MESSAGE" -> listener.onTextMessage(message)
            "VOICE_MESSAGE" -> listener.onVoiceMessage(message)
            // ... 其他消息类型
        }
    }
}
```

### C.2 Flutter WebSocket集成

```dart
class MessageWebSocket {
  IOWebSocketChannel? _channel;
  final String token;
  final MessageCallback onMessage;
  
  MessageWebSocket({
    required this.token,
    required this.onMessage,
  });
  
  void connect() {
    _channel = IOWebSocketChannel.connect(
      Uri.parse('wss://api.yinlingshouhou.com/ws?token=$token'),
    );
    
    _channel!.stream.listen(
      (message) {
        final data = jsonDecode(message);
        onMessage(data);
      },
      onError: (error) {
        print('WebSocket error: $error');
        _reconnect();
      },
      onDone: () {
        print('WebSocket closed');
        _reconnect();
      },
    );
    
    _startHeartbeat();
  }
  
  void sendMessage(Map<String, dynamic> message) {
    _channel?.sink.add(jsonEncode(message));
  }
  
  void _startHeartbeat() {
    Timer.periodic(Duration(seconds: 30), (timer) {
      sendMessage({
        'type': 'PING',
        'messageId': 'ping_${DateTime.now().millisecondsSinceEpoch}',
        'timestamp': DateTime.now().millisecondsSinceEpoch,
      });
    });
  }
  
  void disconnect() {
    _channel?.sink.close();
  }
}
```
