# 银龄守候·双模交互版 - 用户认证接口文档

> 文档版本：v1.0  
> 更新日期：2025年12月21日  
> 文档状态：待完善

---

## 目录

- [1. 接口概述](#1-接口概述)
- [2. 通用规范](#2-通用规范)
- [3. 用户注册接口](#3-用户注册接口)
- [4. 用户登录接口](#4-用户登录接口)
- [5. Token刷新接口](#5-token刷新接口)
- [6. 家庭绑定接口](#6-家庭绑定接口)
- [7. 错误码定义](#7-错误码定义)

---

## 1. 接口概述

### 1.1 基础信息

- **服务名称**：用户认证服务 (user-service)
- **基础路径**：`/api/v1/auth`
- **通信协议**：HTTPS
- **数据格式**：JSON
- **字符编码**：UTF-8

### 1.2 认证方式

| 方式 | 说明 | 适用场景 |
|:----|:----|:---------|
| JWT Token | Bearer认证 | 老年端/子女端APP |
| API Key | Header认证 | 服务间调用 |
| 无需认证 | 公开接口 | 注册、登录 |

### 1.3 JWT Token示例

```http
GET /api/v1/user/profile HTTP/1.1
Host: api.yinlingshouhou.com
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json
```

**Token结构**：

```json
{
  "sub": "1001",
  "username": "elder_zhang",
  "role": "ELDER",
  "exp": 1704153600,
  "iat": 1704067200
}
```

## 2. 通用规范

### 2.1 统一响应格式

#### 成功响应

```json
{
  "code": 200,
  "message": "success",
  "data": {
    // 具体数据
  },
  "timestamp": 1704067200000
}
```

#### 失败响应

```json
{
  "code": 400,
  "message": "invalid_phone_number",
  "errors": [
    {
      "field": "phone",
      "message": "手机号格式不正确"
    }
  ],
  "timestamp": 1704067200000
}
```

### 2.2 HTTP状态码

| 状态码 | 含义 | 说明 |
|:------|:-----|:-----|
| 200 | OK | 请求成功 |
| 201 | Created | 创建成功 |
| 400 | Bad Request | 请求参数错误 |
| 401 | Unauthorized | 未授权/Token过期 |
| 403 | Forbidden | 无权限访问 |
| 404 | Not Found | 资源不存在 |
| 409 | Conflict | 资源冲突（如用户已存在） |
| 500 | Internal Error | 服务器错误 |

### 2.3 请求头

#### 必选请求头

| 字段 | 值 | 说明 |
|:-----|:---|:-----|
| Content-Type | application/json | 数据格式 |
| User-Agent | App/1.0.0 (Android; 13) | 客户端信息 |

#### 可选请求头

| 字段 | 值 | 说明 |
|:-----|:---|:-----|
| X-Device-Id | device_unique_id | 设备唯一标识 |
| X-App-Version | 1.0.0 | 应用版本 |
| X-Platform | android/ios/web | 平台类型 |

## 3. 用户注册接口

### 3.1 老年用户注册

**接口地址**：`POST /api/v1/auth/register/elder`

**请求参数**：

```json
{
  "phone": "13800138000",
  "password": "Abc123456",
  "name": "张大爹",
  "birthYear": 1955,
  "gender": "MALE",
  "verificationCode": "123456"
}
```

**字段说明**：

| 字段 | 类型 | 必填 | 说明 |
|:-----|:-----|:-----|:-----|
| phone | String | ✔ | 手机号（11位） |
| password | String | ✔ | 密码（6-20位） |
| name | String | ✔ | 姓名（2-10字符） |
| birthYear | Integer | ✔ | 出生年份 |
| gender | String | ✔ | 性别：MALE/FEMALE |
| verificationCode | String | ✔ | 手机验证码 |

**响应示例**：

```json
{
  "code": 201,
  "message": "success",
  "data": {
    "userId": 1001,
    "phone": "13800138000",
    "name": "张大爹",
    "role": "ELDER",
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expiresIn": 86400
  },
  "timestamp": 1704067200000
}
```

### 3.2 子女用户注册

**接口地址**：`POST /api/v1/auth/register/family`

**请求参数**：

```json
{
  "phone": "13900139000",
  "password": "Abc123456",
  "name": "张小明",
  "relation": "SON",
  "verificationCode": "123456"
}
```

**字段说明**：

| 字段 | 类型 | 必填 | 说明 |
|:-----|:-----|:-----|:-----|
| phone | String | ✔ | 手机号 |
| password | String | ✔ | 密码 |
| name | String | ✔ | 姓名 |
| relation | String | ✔ | 关系：SON/DAUGHTER/OTHER |
| verificationCode | String | ✔ | 验证码 |

**响应格式**：同老年用户注册。

### 3.3 获取验证码

**接口地址**：`POST /api/v1/auth/sms/send`

**请求参数**：

```json
{
  "phone": "13800138000",
  "type": "REGISTER"
}
```

**类型说明**：
- `REGISTER`：注册
- `LOGIN`：登录
- `RESET_PASSWORD`：重置密码
- `BIND_FAMILY`：绑定家庭

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "sent": true,
    "expiresIn": 300
  },
  "timestamp": 1704067200000
}
```

## 4. 用户登录接口

### 4.1 密码登录

**接口地址**：`POST /api/v1/auth/login`

**请求参数**：

```json
{
  "phone": "13800138000",
  "password": "Abc123456",
  "deviceId": "device_unique_id"
}
```

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "userId": 1001,
    "phone": "13800138000",
    "name": "张大爹",
    "role": "ELDER",
    "avatar": "https://oss.example.com/avatars/1001.jpg",
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expiresIn": 86400,
    "hasFamily": true,
    "familyMembers": [
      {
        "userId": 2001,
        "name": "张小明",
        "relation": "SON",
        "phone": "13900139000"
      }
    ]
  },
  "timestamp": 1704067200000
}
```

### 4.2 验证码登录

**接口地址**：`POST /api/v1/auth/login/sms`

**请求参数**：

```json
{
  "phone": "13800138000",
  "verificationCode": "123456",
  "deviceId": "device_unique_id"
}
```

**响应格式**：同密码登录。

### 4.3 登出

**接口地址**：`POST /api/v1/auth/logout`

**请求头**：
```
Authorization: Bearer {accessToken}
```

**请求参数**：无

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "loggedOut": true
  },
  "timestamp": 1704067200000
}
```

## 5. Token刷新接口

### 5.1 刷新Access Token

**接口地址**：`POST /api/v1/auth/refresh`

**请求参数**：

```json
{
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expiresIn": 86400
  },
  "timestamp": 1704067200000
}
```

### 5.2 Token有效期

| Token类型 | 有效期 | 说明 |
|:----------|:------|:-----|
| accessToken | 24小时 | 访问Token，用于API认证 |
| refreshToken | 30天 | 刷新Token，用于获取新的accessToken |

### 5.3 Token安全建议

1. **存储**：access token存内存，refresh token存加密存储
2. **传输**：仅通过HTTPS传输
3. **刷新**：接口返回401时自动刷新
4. **退出**：登出时清除所有token

## 6. 家庭绑定接口

### 6.1 生成绑定码

**接口地址**：`POST /api/v1/auth/family/generate-code`

**请求头**：
```
Authorization: Bearer {elderAccessToken}
```

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "bindingCode": "ABC123",
    "qrCode": "https://oss.example.com/qr/ABC123.png",
    "expiresIn": 300,
    "expiresAt": 1704067500000
  },
  "timestamp": 1704067200000
}
```

### 6.2 子女绑定老人

**接口地址**：`POST /api/v1/auth/family/bind`

**请求头**：
```
Authorization: Bearer {familyAccessToken}
```

**请求参数**：

```json
{
  "bindingCode": "ABC123",
  "relation": "SON",
  "nickname": "儿子"
}
```

**关系类型**：
- `SON`：儿子
- `DAUGHTER`：女儿
- `SON_IN_LAW`：女婿
- `DAUGHTER_IN_LAW`：儿媳妇
- `GRANDSON`：孙子/外孙
- `GRANDDAUGHTER`：孙女/外孙女
- `OTHER`：其他

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "familyId": "family_1001_2001",
    "elderInfo": {
      "userId": 1001,
      "name": "张大爹",
      "phone": "138****8000",
      "birthYear": 1955
    },
    "relation": "SON",
    "bindTime": 1704067200000
  },
  "timestamp": 1704067200000
}
```

### 6.3 查询家庭成员

**接口地址**：`GET /api/v1/auth/family/members`

**请求头**：
```
Authorization: Bearer {accessToken}
```

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "members": [
      {
        "userId": 2001,
        "name": "张小明",
        "phone": "139****9000",
        "relation": "SON",
        "nickname": "儿子",
        "avatar": "https://oss.example.com/avatars/2001.jpg",
        "bindTime": 1704067200000
      },
      {
        "userId": 2002,
        "name": "张小芳",
        "phone": "135****5000",
        "relation": "DAUGHTER",
        "nickname": "女儿",
        "avatar": "https://oss.example.com/avatars/2002.jpg",
        "bindTime": 1703980800000
      }
    ]
  },
  "timestamp": 1704067200000
}
```

### 6.4 解绑家庭成员

**接口地址**：`DELETE /api/v1/auth/family/unbind/{userId}`

**请求头**：
```
Authorization: Bearer {accessToken}
```

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "unbound": true
  },
  "timestamp": 1704067200000
}
```

## 7. 错误码定义

### 7.1 通用错误码

| 错误码 | 错误消息 | 说明 |
|:------|:---------|:-----|
| 200 | success | 成功 |
| 400 | bad_request | 请求参数错误 |
| 401 | unauthorized | 未授权 |
| 403 | forbidden | 禁止访问 |
| 404 | not_found | 资源不存在 |
| 409 | conflict | 资源冲突 |
| 429 | too_many_requests | 请求过于频繁 |
| 500 | internal_error | 服务器错误 |

### 7.2 认证相关错误

| 错误码 | 错误消息 | 说明 |
|:------|:---------|:-----|
| 1001 | invalid_phone_number | 手机号格式错误 |
| 1002 | invalid_password | 密码格式错误 |
| 1003 | phone_already_exists | 手机号已注册 |
| 1004 | invalid_verification_code | 验证码错误 |
| 1005 | verification_code_expired | 验证码已过期 |
| 1006 | user_not_found | 用户不存在 |
| 1007 | wrong_password | 密码错误 |
| 1008 | account_disabled | 账号已禁用 |
| 1009 | token_expired | Token已过期 |
| 1010 | invalid_token | Token无效 |
| 1011 | token_revoked | Token已撤销 |

### 7.3 家庭绑定错误

| 错误码 | 错误消息 | 说明 |
|:------|:---------|:-----|
| 2001 | invalid_binding_code | 绑定码错误 |
| 2002 | binding_code_expired | 绑定码已过期 |
| 2003 | already_bound | 已经绑定 |
| 2004 | family_limit_exceeded | 家庭成员数超限 |
| 2005 | cannot_bind_self | 不能绑定自己 |

### 7.4 错误响应示例

#### 参数验证错误

```json
{
  "code": 400,
  "message": "invalid_phone_number",
  "errors": [
    {
      "field": "phone",
      "message": "手机号格式不正确，应为11位数字"
    }
  ],
  "timestamp": 1704067200000
}
```

#### 认证失败

```json
{
  "code": 401,
  "message": "token_expired",
  "errors": [
    {
      "field": "authorization",
      "message": "Token已过期，请重新登录"
    }
  ],
  "timestamp": 1704067200000
}
```

#### 资源冲突

```json
{
  "code": 409,
  "message": "phone_already_exists",
  "errors": [
    {
      "field": "phone",
      "message": "该手机号已被注册"
    }
  ],
  "timestamp": 1704067200000
}
```

---

## 附录：安全设计

### A.1 密码规则

- **长度**：6-20位
- **复杂度**（至少满足两项）：
  - 大写字母
  - 小写字母
  - 数字
  - 特殊字符

### A.2 验证码规则

- **格式**：6位数字
- **有效期**：5分钟
- **频率限制**：同一手机号1分钟内只能发送1次
- **次数限制**：同一手机号每天1小时最多发5次

### A.3 JWT Token配置

```yaml
jwt:
  secret: ${JWT_SECRET:your-256-bit-secret}
  access-token-expiration: 86400000  # 24小时
  refresh-token-expiration: 2592000000  # 30天
  issuer: yinlingshouhou
  algorithm: HS256
```

### A.4 接口限流

| 接口 | 限制 | 窗口期 |
|:----|:-----|:--------|
| 发送验证码 | 1次/分钟 | 60秒 |
| 登录 | 5次/分钟 | 60秒 |
| 注册 | 3次/小时 | 3600秒 |
| 其他接口 | 100次/分钟 | 60秒 |
