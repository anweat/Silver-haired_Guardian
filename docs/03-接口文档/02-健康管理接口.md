# 银龄守候·双模交互版 - 健康管理接口文档

> 文档版本：v1.0  
> 更新日期：2025年12月21日  
> 文档状态：待完善

---

## 目录

- [1. 接口概述](#1-接口概述)
- [2. 药品识别接口](#2-药品识别接口)
- [3. 用药提醒接口](#3-用药提醒接口)
- [4. 健康数据接口](#4-健康数据接口)
- [5. 健康报告接口](#5-健康报告接口)
- [6. 错误码定义](#6-错误码定义)

---

## 1. 接口概述

### 1.1 基础信息

- **服务名称**：健康管理服务 (health-service)
- **基础路径**：`/api/v1/health`
- **认证方式**：JWT Bearer Token
- **数据格式**：JSON
- **字符编码**：UTF-8

### 1.2 功能模块

| 模块 | 说明 | 主要功能 |
|:----|:----|:---------|
| 药品识别 | AI识别药品信息 | OCR识别、药品查询、用法说明 |
| 用药提醒 | 智能用药管理 | 创建提醒、定时推送、服药记录 |
| 健康数据 | 健康指标记录 | 血压、血糖、心率等数据管理 |
| 健康报告 | 数据分析报告 | 趋势分析、异常提醒、周月报告 |

### 1.3 依赖服务

```
健康管理服务
    ├── AI服务 (图像识别、OCR)
    ├── 消息服务 (推送提醒)
    ├── 用户服务 (用户信息)
    └── OSS服务 (图片存储)
```

## 2. 药品识别接口

### 2.1 上传药品图片识别

**接口地址**：`POST /api/v1/health/medicine/recognize`

**请求头**：
```
Authorization: Bearer {accessToken}
Content-Type: multipart/form-data
```

**请求参数**：

| 字段 | 类型 | 必填 | 说明 |
|:----|:----|:----|:-----|
| image | File | ✔ | 药品图片（JPG/PNG，≤5MB） |
| scene | String | ✘ | 识别场景：PACKAGE(包装)/INSTRUCTIONS(说明书) |

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "recognizeId": "rec_1704067200_001",
    "medicineInfo": {
      "name": "阿司匹林肠溶片",
      "manufacturer": "拜耳医药保健有限公司",
      "specification": "100mg*30片",
      "approvalNumber": "国药准字H20050052",
      "category": "处方药",
      "ingredients": "阿司匹林",
      "indications": "用于预防心肌梗死、短暂性脑缺血发作",
      "usage": {
        "dosage": "一次100mg，一日1次",
        "method": "口服",
        "precautions": [
          "饭后服用",
          "整片吞服，不得嚼碎"
        ]
      },
      "adverseReactions": "可能引起胃肠道不适",
      "contraindications": "活动性溃疡、出血性疾病患者禁用",
      "imageUrl": "https://oss.example.com/medicine/1704067200_001.jpg"
    },
    "confidence": 0.95,
    "ocrText": "识别的原始文字内容...",
    "recognizeTime": 1704067200000
  },
  "timestamp": 1704067200000
}
```

### 2.2 根据药品名称查询

**接口地址**：`GET /api/v1/health/medicine/search`

**请求参数**：

| 字段 | 类型 | 必填 | 说明 |
|:----|:----|:----|:-----|
| keyword | String | ✔ | 药品名称关键词 |
| page | Integer | ✘ | 页码，默认1 |
| pageSize | Integer | ✘ | 每页数量，默认10 |

**示例**：`GET /api/v1/health/medicine/search?keyword=阿司匹林&page=1&pageSize=10`

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 25,
    "page": 1,
    "pageSize": 10,
    "medicines": [
      {
        "medicineId": "med_10001",
        "name": "阿司匹林肠溶片",
        "manufacturer": "拜耳医药保健有限公司",
        "specification": "100mg*30片",
        "price": 15.80,
        "imageUrl": "https://oss.example.com/medicine/med_10001.jpg"
      }
    ]
  },
  "timestamp": 1704067200000
}
```

### 2.3 获取药品详情

**接口地址**：`GET /api/v1/health/medicine/{medicineId}`

**路径参数**：
- `medicineId`：药品ID

**响应格式**：同2.1识别接口的medicineInfo结构

### 2.4 识别历史记录

**接口地址**：`GET /api/v1/health/medicine/history`

**请求参数**：

| 字段 | 类型 | 必填 | 说明 |
|:----|:----|:----|:-----|
| startDate | String | ✘ | 开始日期 YYYY-MM-DD |
| endDate | String | ✘ | 结束日期 YYYY-MM-DD |
| page | Integer | ✘ | 页码 |
| pageSize | Integer | ✘ | 每页数量 |

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 15,
    "records": [
      {
        "recognizeId": "rec_1704067200_001",
        "medicineName": "阿司匹林肠溶片",
        "imageUrl": "https://oss.example.com/medicine/1704067200_001.jpg",
        "recognizeTime": 1704067200000,
        "hasReminder": true
      }
    ]
  },
  "timestamp": 1704067200000
}
```

## 3. 用药提醒接口

### 3.1 创建用药提醒

**接口地址**：`POST /api/v1/health/reminder`

**请求参数**：

```json
{
  "medicineName": "阿司匹林肠溶片",
  "medicineId": "med_10001",
  "dosage": "1片",
  "frequency": "DAILY",
  "times": [
    {
      "hour": 8,
      "minute": 0
    }
  ],
  "startDate": "2025-01-01",
  "endDate": "2025-03-31",
  "beforeMeal": false,
  "notes": "饭后服用",
  "notifyFamily": true
}
```

**字段说明**：

| 字段 | 类型 | 必填 | 说明 |
|:----|:----|:----|:-----|
| medicineName | String | ✔ | 药品名称 |
| medicineId | String | ✘ | 药品ID（识别后自动填充） |
| dosage | String | ✔ | 用量 |
| frequency | String | ✔ | 频率：DAILY/WEEKLY/CUSTOM |
| times | Array | ✔ | 每日服药时间点 |
| startDate | String | ✔ | 开始日期 |
| endDate | String | ✘ | 结束日期（为空表示长期） |
| beforeMeal | Boolean | ✘ | 是否饭前服用 |
| notes | String | ✘ | 备注说明 |
| notifyFamily | Boolean | ✘ | 是否通知家人 |

**频率选项**：
- `DAILY`：每天
- `WEEKLY`：每周（需指定weekDays数组）
- `CUSTOM`：自定义（需指定具体日期）

**响应示例**：

```json
{
  "code": 201,
  "message": "success",
  "data": {
    "reminderId": "rem_1001",
    "medicineName": "阿司匹林肠溶片",
    "nextReminderTime": 1704672000000,
    "totalReminders": 90
  },
  "timestamp": 1704067200000
}
```

### 3.2 获取提醒列表

**接口地址**：`GET /api/v1/health/reminder/list`

**请求参数**：

| 字段 | 类型 | 必填 | 说明 |
|:----|:----|:----|:-----|
| status | String | ✘ | 状态：ACTIVE/COMPLETED/PAUSED |
| date | String | ✘ | 指定日期 YYYY-MM-DD |

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "reminders": [
      {
        "reminderId": "rem_1001",
        "medicineName": "阿司匹林肠溶片",
        "dosage": "1片",
        "time": "08:00",
        "status": "PENDING",
        "beforeMeal": false,
        "notes": "饭后服用"
      },
      {
        "reminderId": "rem_1002",
        "medicineName": "降压药",
        "dosage": "半片",
        "time": "20:00",
        "status": "TAKEN",
        "takenTime": 1704121200000
      }
    ],
    "todayTotal": 2,
    "todayTaken": 1,
    "completionRate": 0.5
  },
  "timestamp": 1704067200000
}
```

### 3.3 记录服药

**接口地址**：`POST /api/v1/health/reminder/{reminderId}/take`

**请求参数**：

```json
{
  "actualTime": 1704067200000,
  "actualDosage": "1片",
  "notes": "按时服用"
}
```

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "recordId": "record_10001",
    "reminderId": "rem_1001",
    "takenTime": 1704067200000,
    "onTime": true,
    "streak": 7
  },
  "timestamp": 1704067200000
}
```

### 3.4 修改提醒

**接口地址**：`PUT /api/v1/health/reminder/{reminderId}`

**请求参数**：同创建提醒

### 3.5 暂停/恢复提醒

**接口地址**：`PATCH /api/v1/health/reminder/{reminderId}/status`

**请求参数**：

```json
{
  "status": "PAUSED",
  "reason": "暂时停药"
}
```

**状态选项**：
- `ACTIVE`：激活
- `PAUSED`：暂停
- `COMPLETED`：完成

### 3.6 删除提醒

**接口地址**：`DELETE /api/v1/health/reminder/{reminderId}`

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "deleted": true
  },
  "timestamp": 1704067200000
}
```

### 3.7 服药统计

**接口地址**：`GET /api/v1/health/reminder/statistics`

**请求参数**：

| 字段 | 类型 | 必填 | 说明 |
|:----|:----|:----|:-----|
| startDate | String | ✔ | 开始日期 |
| endDate | String | ✔ | 结束日期 |
| reminderId | String | ✘ | 指定提醒ID |

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "period": {
      "startDate": "2025-01-01",
      "endDate": "2025-01-31",
      "days": 31
    },
    "statistics": {
      "totalReminders": 93,
      "takenCount": 85,
      "missedCount": 8,
      "completionRate": 0.914,
      "onTimeRate": 0.882,
      "longestStreak": 12,
      "currentStreak": 7
    },
    "dailyStats": [
      {
        "date": "2025-01-01",
        "planned": 3,
        "taken": 3,
        "missed": 0
      }
    ]
  },
  "timestamp": 1704067200000
}
```

## 4. 健康数据接口

### 4.1 记录健康数据

**接口地址**：`POST /api/v1/health/data`

**请求参数**：

```json
{
  "dataType": "BLOOD_PRESSURE",
  "values": {
    "systolic": 120,
    "diastolic": 80,
    "pulse": 72
  },
  "measureTime": 1704067200000,
  "unit": "mmHg",
  "notes": "早晨测量",
  "deviceId": "bp_device_001"
}
```

**数据类型**：

| 类型 | dataType | values字段 | 单位 |
|:----|:---------|:----------|:-----|
| 血压 | BLOOD_PRESSURE | systolic, diastolic, pulse | mmHg, bpm |
| 血糖 | BLOOD_GLUCOSE | value | mmol/L |
| 心率 | HEART_RATE | value | bpm |
| 体重 | WEIGHT | value | kg |
| 体温 | TEMPERATURE | value | °C |
| 血氧 | BLOOD_OXYGEN | value | % |
| 步数 | STEPS | value | 步 |

**响应示例**：

```json
{
  "code": 201,
  "message": "success",
  "data": {
    "recordId": "health_rec_10001",
    "dataType": "BLOOD_PRESSURE",
    "values": {
      "systolic": 120,
      "diastolic": 80,
      "pulse": 72
    },
    "measureTime": 1704067200000,
    "status": "NORMAL",
    "alert": null,
    "trend": "STABLE"
  },
  "timestamp": 1704067200000
}
```

**健康状态判断**：

| 数据类型 | 正常范围 | 警告范围 | 危险范围 |
|:--------|:---------|:---------|:---------|
| 血压（收缩压） | 90-139 | 140-159 | ≥160 或 <90 |
| 血压（舒张压） | 60-89 | 90-99 | ≥100 或 <60 |
| 血糖（空腹） | 3.9-6.1 | 6.1-7.0 | >7.0 或 <3.9 |
| 心率 | 60-100 | 100-120 | >120 或 <60 |
| 血氧 | ≥95 | 90-94 | <90 |

### 4.2 获取健康数据列表

**接口地址**：`GET /api/v1/health/data/list`

**请求参数**：

| 字段 | 类型 | 必填 | 说明 |
|:----|:----|:----|:-----|
| dataType | String | ✔ | 数据类型 |
| startDate | String | ✘ | 开始日期 YYYY-MM-DD |
| endDate | String | ✘ | 结束日期 YYYY-MM-DD |
| page | Integer | ✘ | 页码 |
| pageSize | Integer | ✘ | 每页数量 |

**示例**：`GET /api/v1/health/data/list?dataType=BLOOD_PRESSURE&startDate=2025-01-01&endDate=2025-01-31`

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 30,
    "dataType": "BLOOD_PRESSURE",
    "records": [
      {
        "recordId": "health_rec_10001",
        "values": {
          "systolic": 120,
          "diastolic": 80,
          "pulse": 72
        },
        "measureTime": 1704067200000,
        "status": "NORMAL",
        "notes": "早晨测量"
      },
      {
        "recordId": "health_rec_10002",
        "values": {
          "systolic": 145,
          "diastolic": 92,
          "pulse": 85
        },
        "measureTime": 1704153600000,
        "status": "WARNING",
        "notes": "晚上测量"
      }
    ],
    "statistics": {
      "avg": {
        "systolic": 128,
        "diastolic": 84,
        "pulse": 76
      },
      "max": {
        "systolic": 145,
        "diastolic": 92,
        "pulse": 95
      },
      "min": {
        "systolic": 110,
        "diastolic": 70,
        "pulse": 65
      }
    }
  },
  "timestamp": 1704067200000
}
```

### 4.3 获取最新健康数据

**接口地址**：`GET /api/v1/health/data/latest`

**请求参数**：

| 字段 | 类型 | 必填 | 说明 |
|:----|:----|:----|:-----|
| dataType | String | ✘ | 数据类型（为空返回所有类型） |

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "healthData": {
      "BLOOD_PRESSURE": {
        "recordId": "health_rec_10001",
        "values": {
          "systolic": 120,
          "diastolic": 80,
          "pulse": 72
        },
        "measureTime": 1704067200000,
        "status": "NORMAL"
      },
      "BLOOD_GLUCOSE": {
        "recordId": "health_rec_20001",
        "values": {
          "value": 5.6
        },
        "measureTime": 1704064800000,
        "status": "NORMAL"
      },
      "WEIGHT": {
        "recordId": "health_rec_30001",
        "values": {
          "value": 68.5
        },
        "measureTime": 1703980800000,
        "status": "NORMAL"
      }
    }
  },
  "timestamp": 1704067200000
}
```

### 4.4 删除健康数据

**接口地址**：`DELETE /api/v1/health/data/{recordId}`

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "deleted": true
  },
  "timestamp": 1704067200000
}
```

### 4.5 批量导入健康数据

**接口地址**：`POST /api/v1/health/data/batch`

**请求参数**：

```json
{
  "dataType": "BLOOD_PRESSURE",
  "records": [
    {
      "values": {
        "systolic": 120,
        "diastolic": 80,
        "pulse": 72
      },
      "measureTime": 1704067200000
    },
    {
      "values": {
        "systolic": 118,
        "diastolic": 78,
        "pulse": 70
      },
      "measureTime": 1704153600000
    }
  ]
}
```

**响应示例**：

```json
{
  "code": 201,
  "message": "success",
  "data": {
    "totalRecords": 2,
    "successCount": 2,
    "failedCount": 0,
    "recordIds": [
      "health_rec_10001",
      "health_rec_10002"
    ]
  },
  "timestamp": 1704067200000
}
```

### 4.6 健康数据趋势分析

**接口地址**：`GET /api/v1/health/data/trend`

**请求参数**：

| 字段 | 类型 | 必填 | 说明 |
|:----|:----|:----|:-----|
| dataType | String | ✔ | 数据类型 |
| period | String | ✔ | 周期：WEEK/MONTH/QUARTER/YEAR |
| startDate | String | ✘ | 开始日期 |

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "dataType": "BLOOD_PRESSURE",
    "period": "MONTH",
    "startDate": "2025-01-01",
    "endDate": "2025-01-31",
    "trend": "RISING",
    "trendDescription": "血压呈上升趋势，请注意控制",
    "dataPoints": [
      {
        "date": "2025-01-01",
        "avg": {
          "systolic": 118,
          "diastolic": 78
        }
      },
      {
        "date": "2025-01-08",
        "avg": {
          "systolic": 125,
          "diastolic": 82
        }
      },
      {
        "date": "2025-01-15",
        "avg": {
          "systolic": 132,
          "diastolic": 86
        }
      }
    ],
    "analysis": {
      "overallStatus": "WARNING",
      "abnormalDays": 5,
      "normalDays": 25,
      "recommendations": [
        "建议减少盐分摄入",
        "保持规律运动",
        "定期监测血压变化"
      ]
    }
  },
  "timestamp": 1704067200000
}
```

## 5. 健康报告接口

### 5.1 生成健康报告

**接口地址**：`POST /api/v1/health/report/generate`

**请求参数**：

```json
{
  "reportType": "WEEKLY",
  "startDate": "2025-01-01",
  "endDate": "2025-01-07",
  "dataTypes": [
    "BLOOD_PRESSURE",
    "BLOOD_GLUCOSE",
    "WEIGHT"
  ],
  "includeRecommendations": true
}
```

**报告类型**：
- `DAILY`：日报
- `WEEKLY`：周报
- `MONTHLY`：月报
- `CUSTOM`：自定义时间段

**响应示例**：

```json
{
  "code": 201,
  "message": "success",
  "data": {
    "reportId": "report_20250101_001",
    "reportType": "WEEKLY",
    "period": {
      "startDate": "2025-01-01",
      "endDate": "2025-01-07"
    },
    "summary": {
      "overallScore": 85,
      "overallStatus": "GOOD",
      "totalDataPoints": 45,
      "abnormalCount": 3
    },
    "dataAnalysis": [
      {
        "dataType": "BLOOD_PRESSURE",
        "recordCount": 14,
        "status": "NORMAL",
        "average": {
          "systolic": 125,
          "diastolic": 82,
          "pulse": 75
        },
        "trend": "STABLE",
        "abnormalDays": 1,
        "notes": "血压控制良好"
      },
      {
        "dataType": "BLOOD_GLUCOSE",
        "recordCount": 21,
        "status": "WARNING",
        "average": {
          "value": 6.8
        },
        "trend": "RISING",
        "abnormalDays": 2,
        "notes": "血糖略高，需要注意饮食"
      }
    ],
    "medicineCompliance": {
      "totalReminders": 21,
      "takenCount": 20,
      "missedCount": 1,
      "complianceRate": 0.952
    },
    "recommendations": [
      {
        "category": "DIET",
        "priority": "HIGH",
        "content": "建议减少糖分摄入，控制碳水化合物"
      },
      {
        "category": "EXERCISE",
        "priority": "MEDIUM",
        "content": "建议每天进行30分钟有氧运动"
      },
      {
        "category": "MEDICATION",
        "priority": "LOW",
        "content": "用药依从性良好，请继续保持"
      }
    ],
    "generatedTime": 1704067200000,
    "pdfUrl": "https://oss.example.com/reports/report_20250101_001.pdf"
  },
  "timestamp": 1704067200000
}
```

### 5.2 获取报告列表

**接口地址**：`GET /api/v1/health/report/list`

**请求参数**：

| 字段 | 类型 | 必填 | 说明 |
|:----|:----|:----|:-----|
| reportType | String | ✘ | 报告类型 |
| startDate | String | ✘ | 开始日期 |
| endDate | String | ✘ | 结束日期 |
| page | Integer | ✘ | 页码 |
| pageSize | Integer | ✘ | 每页数量 |

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 12,
    "reports": [
      {
        "reportId": "report_20250101_001",
        "reportType": "WEEKLY",
        "period": {
          "startDate": "2025-01-01",
          "endDate": "2025-01-07"
        },
        "overallScore": 85,
        "overallStatus": "GOOD",
        "generatedTime": 1704067200000,
        "pdfUrl": "https://oss.example.com/reports/report_20250101_001.pdf"
      }
    ]
  },
  "timestamp": 1704067200000
}
```

### 5.3 获取报告详情

**接口地址**：`GET /api/v1/health/report/{reportId}`

**响应格式**：同5.1生成报告的响应

### 5.4 分享报告给家人

**接口地址**：`POST /api/v1/health/report/{reportId}/share`

**请求参数**：

```json
{
  "familyUserIds": [2001, 2002],
  "message": "这是我本周的健康报告"
}
```

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "reportId": "report_20250101_001",
    "sharedTo": [
      {
        "userId": 2001,
        "name": "张小明",
        "shareTime": 1704067200000
      },
      {
        "userId": 2002,
        "name": "张小芳",
        "shareTime": 1704067200000
      }
    ]
  },
  "timestamp": 1704067200000
}
```

### 5.5 下载报告PDF

**接口地址**：`GET /api/v1/health/report/{reportId}/download`

**响应**：返回PDF文件流

**请求头**：
```
Authorization: Bearer {accessToken}
```

**响应头**：
```
Content-Type: application/pdf
Content-Disposition: attachment; filename="health_report_20250101.pdf"
```

### 5.6 健康评分说明

**评分维度**：

| 维度 | 权重 | 说明 |
|:----|:-----|:-----|
| 数据完整性 | 20% | 是否按时记录健康数据 |
| 指标正常率 | 40% | 健康指标在正常范围内的比例 |
| 用药依从性 | 25% | 按时服药的比例 |
| 趋势稳定性 | 15% | 健康指标的波动情况 |

**评分等级**：

| 分数 | 等级 | 状态 | 说明 |
|:-----|:-----|:-----|:-----|
| 90-100 | 优秀 | EXCELLENT | 健康状况非常好 |
| 80-89 | 良好 | GOOD | 健康状况良好 |
| 70-79 | 一般 | FAIR | 需要关注某些指标 |
| 60-69 | 较差 | POOR | 存在健康风险 |
| <60 | 危险 | CRITICAL | 需要立即就医 |

### 5.7 定期报告设置

**接口地址**：`POST /api/v1/health/report/schedule`

**请求参数**：

```json
{
  "reportType": "WEEKLY",
  "frequency": "EVERY_MONDAY",
  "autoGenerate": true,
  "autoShare": true,
  "recipientUserIds": [2001, 2002],
  "notifyTime": "09:00"
}
```

**频率选项**：
- `EVERY_MONDAY`：每周一
- `FIRST_DAY_OF_MONTH`：每月1日
- `CUSTOM`：自定义

**响应示例**：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "scheduleId": "schedule_001",
    "reportType": "WEEKLY",
    "frequency": "EVERY_MONDAY",
    "nextGenerateTime": 1704672000000,
    "enabled": true
  },
  "timestamp": 1704067200000
}
```

## 6. 错误码定义

### 6.1 通用错误码

| 错误码 | 错误消息 | 说明 |
|:------|:--------|:-----|
| 200 | success | 成功 |
| 400 | bad_request | 请求参数错误 |
| 401 | unauthorized | 未授权 |
| 403 | forbidden | 禁止访问 |
| 404 | not_found | 资源不存在 |
| 500 | internal_error | 服务器错误 |

### 6.2 药品识别错误

| 错误码 | 错误消息 | 说明 |
|:------|:--------|:-----|
| 3001 | invalid_image_format | 图片格式不支持 |
| 3002 | image_too_large | 图片文件过大 |
| 3003 | image_quality_too_low | 图片质量过低，无法识别 |
| 3004 | no_medicine_detected | 未检测到药品信息 |
| 3005 | ocr_service_unavailable | OCR服务不可用 |
| 3006 | medicine_not_found | 药品信息未找到 |
| 3007 | recognition_failed | 识别失败 |

### 6.3 用药提醒错误

| 错误码 | 错误消息 | 说明 |
|:------|:--------|:-----|
| 3101 | invalid_reminder_time | 提醒时间无效 |
| 3102 | reminder_not_found | 提醒不存在 |
| 3103 | reminder_already_taken | 该提醒已记录服药 |
| 3104 | reminder_limit_exceeded | 提醒数量超限 |
| 3105 | invalid_frequency | 频率设置无效 |
| 3106 | end_date_before_start | 结束日期早于开始日期 |
| 3107 | reminder_conflict | 提醒时间冲突 |

### 6.4 健康数据错误

| 错误码 | 错误消息 | 说明 |
|:------|:--------|:-----|
| 3201 | invalid_data_type | 数据类型无效 |
| 3202 | invalid_data_value | 数据值超出合理范围 |
| 3203 | health_record_not_found | 健康记录不存在 |
| 3204 | duplicate_record | 重复的记录（同一时间点） |
| 3205 | invalid_date_range | 日期范围无效 |
| 3206 | data_import_failed | 数据导入失败 |

### 6.5 健康报告错误

| 错误码 | 错误消息 | 说明 |
|:------|:--------|:-----|
| 3301 | report_not_found | 报告不存在 |
| 3302 | insufficient_data | 数据不足，无法生成报告 |
| 3303 | report_generation_failed | 报告生成失败 |
| 3304 | invalid_report_type | 报告类型无效 |
| 3305 | pdf_generation_failed | PDF生成失败 |
| 3306 | share_failed | 分享失败 |

### 6.6 错误响应示例

#### 图片格式错误

```json
{
  "code": 400,
  "message": "invalid_image_format",
  "errors": [
    {
      "field": "image",
      "message": "仅支持JPG、PNG格式的图片"
    }
  ],
  "timestamp": 1704067200000
}
```

#### 数据值异常

```json
{
  "code": 400,
  "message": "invalid_data_value",
  "errors": [
    {
      "field": "values.systolic",
      "message": "收缩压值异常：260超出合理范围(60-300)"
    }
  ],
  "timestamp": 1704067200000
}
```

#### OCR服务不可用

```json
{
  "code": 503,
  "message": "ocr_service_unavailable",
  "errors": [
    {
      "field": "service",
      "message": "OCR识别服务暂时不可用，请稍后重试"
    }
  ],
  "timestamp": 1704067200000
}
```

#### 数据不足

```json
{
  "code": 400,
  "message": "insufficient_data",
  "errors": [
    {
      "field": "data",
      "message": "该时间段内数据不足，至少需要7条记录才能生成报告"
    }
  ],
  "timestamp": 1704067200000
}
```

---

## 附录：业务规则

### A.1 药品识别规则

1. **图片要求**
   - 格式：JPG、PNG
   - 大小：≤5MB
   - 分辨率：≥800x600
   - 清晰度：无模糊、反光

2. **识别优先级**
   - 药品名称 > 批准文号 > 规格 > 用法用量

3. **缓存策略**
   - 识别结果缓存24小时
   - 药品详情缓存7天

### A.2 用药提醒规则

1. **提醒时间**
   - 提前10分钟推送提醒
   - 到点后每5分钟推送一次
   - 最多推送3次

2. **用药依从性计算**
   ```
   依从性 = (按时服药次数 / 总提醒次数) × 100%
   
   - 按时服药：实际服药时间与计划时间差≤30分钟
   - 迟服：超过30分钟但在2小时内
   - 漏服：超过2小时未记录
   ```

3. **提醒限制**
   - 单个用户最多创建50个活跃提醒
   - 单日最多100次提醒

### A.3 健康数据规则

1. **数据合理范围**

| 数据类型 | 最小值 | 最大值 | 说明 |
|:--------|:------|:------|:-----|
| 收缩压 | 60 | 300 | mmHg |
| 舒张压 | 40 | 200 | mmHg |
| 心率 | 30 | 200 | bpm |
| 血糖 | 1.0 | 33.3 | mmol/L |
| 体重 | 20 | 300 | kg |
| 体温 | 30.0 | 45.0 | °C |
| 血氧 | 50 | 100 | % |

2. **数据去重规则**
   - 同一数据类型，同一时间点（精确到分钟）只保留最新一条

3. **异常数据处理**
   - 自动标记异常数据
   - 异常数据推送通知给家人
   - 连续3次异常触发紧急提醒

### A.4 健康报告规则

1. **报告生成条件**

| 报告类型 | 最少数据量 | 时间跨度 |
|:--------|:----------|:---------|
| 日报 | 3条 | 1天 |
| 周报 | 7条 | 7天 |
| 月报 | 15条 | 30天 |

2. **评分算法**

```
总分 = 数据完整性(20%) + 指标正常率(40%) + 用药依从性(25%) + 趋势稳定性(15%)

数据完整性 = (实际记录天数 / 应记录天数) × 100
指标正常率 = (正常数据量 / 总数据量) × 100
用药依从性 = (按时服药次数 / 总提醒次数) × 100
趋势稳定性 = 100 - (标准差 / 均值) × 100
```

3. **建议生成规则**
   - 基于最近30天数据
   - 优先级：CRITICAL > HIGH > MEDIUM > LOW
   - 每个类别最多3条建议

---

## 附录：数据模型

### B.1 药品信息模型

```typescript
interface MedicineInfo {
  medicineId: string;
  name: string;
  manufacturer: string;
  specification: string;
  approvalNumber: string;
  category: string;
  ingredients: string;
  indications: string;
  usage: {
    dosage: string;
    method: string;
    precautions: string[];
  };
  adverseReactions: string;
  contraindications: string;
  imageUrl: string;
}
```

### B.2 健康数据模型

```typescript
interface HealthRecord {
  recordId: string;
  userId: number;
  dataType: DataType;
  values: Record<string, number>;
  measureTime: number;
  unit: string;
  status: HealthStatus;
  alert?: string;
  trend?: Trend;
  notes?: string;
  deviceId?: string;
  createdAt: number;
}

enum DataType {
  BLOOD_PRESSURE = "BLOOD_PRESSURE",
  BLOOD_GLUCOSE = "BLOOD_GLUCOSE",
  HEART_RATE = "HEART_RATE",
  WEIGHT = "WEIGHT",
  TEMPERATURE = "TEMPERATURE",
  BLOOD_OXYGEN = "BLOOD_OXYGEN",
  STEPS = "STEPS"
}

enum HealthStatus {
  NORMAL = "NORMAL",
  WARNING = "WARNING",
  CRITICAL = "CRITICAL"
}

enum Trend {
  RISING = "RISING",
  FALLING = "FALLING",
  STABLE = "STABLE"
}
```

### B.3 用药提醒模型

```typescript
interface MedicineReminder {
  reminderId: string;
  userId: number;
  medicineName: string;
  medicineId?: string;
  dosage: string;
  frequency: Frequency;
  times: TimeSlot[];
  startDate: string;
  endDate?: string;
  beforeMeal: boolean;
  notes?: string;
  status: ReminderStatus;
  notifyFamily: boolean;
  createdAt: number;
}

interface TimeSlot {
  hour: number;
  minute: number;
}

enum Frequency {
  DAILY = "DAILY",
  WEEKLY = "WEEKLY",
  CUSTOM = "CUSTOM"
}

enum ReminderStatus {
  ACTIVE = "ACTIVE",
  PAUSED = "PAUSED",
  COMPLETED = "COMPLETED"
}
```
