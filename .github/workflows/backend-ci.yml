name: Backend CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'backend/**'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: Yinling@2025
          MYSQL_DATABASE: yinling_main
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      
      redis:
        image: redis:7.2-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
    - name: Checkout代码
      uses: actions/checkout@v4

    - name: 设置JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: 缓存Maven依赖
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    - name: Maven编译
      working-directory: ./backend
      run: mvn clean compile -DskipTests

    - name: 运行单元测试
      working-directory: ./backend
      run: mvn test

    - name: 运行集成测试
      working-directory: ./backend
      run: mvn verify -DskipUnitTests

    - name: 生成测试报告
      if: always()
      uses: dorny/test-reporter@v1
      with:
        name: Maven测试报告
        path: 'backend/**/target/surefire-reports/*.xml'
        reporter: java-junit

    - name: 代码覆盖率
      working-directory: ./backend
      run: mvn jacoco:report

    - name: 上传覆盖率报告到Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./backend/**/target/site/jacoco/jacoco.xml
        flags: backend
        name: backend-coverage

    - name: SonarQube扫描
      if: github.event_name == 'pull_request'
      working-directory: ./backend
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        mvn sonar:sonar \
          -Dsonar.projectKey=yinling-guardian \
          -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}

    - name: 构建Docker镜像
      if: github.ref == 'refs/heads/main'
      working-directory: ./backend
      run: |
        mvn clean package -DskipTests
        docker build -t yinling/backend:${{ github.sha }} .

    - name: 推送到Docker Hub
      if: github.ref == 'refs/heads/main'
      env:
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      run: |
        echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
        docker push yinling/backend:${{ github.sha }}
